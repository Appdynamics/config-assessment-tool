name: Create Platform specific bundles
on:
  release:
    types: [ published ]

jobs:

  build-linux:
   name: build linux binary
   runs-on: ubuntu-latest
   steps:
     - name: Checkout repository
       uses: actions/checkout@v2
     - name: Install Python 3
       uses: actions/setup-python@v2
       with:
         python-version: 3.9
     - name: Install dependencies
       run: |
         python -m pip install --upgrade pip
         pip install pipenv pyinstaller
         # install to global namespace and then clean up, no need for venv setup
         pipenv install --dev --system
     - name: Create platform specific tarball/zip bundle using the spec file
       run: |
        pyinstaller dist/config-assessment-tool-linux.spec
        cd dist
        tar -zcvf config-assessment-tool-linux.tgz config-assessment-tool-linux
     - name: Release the bundle for linux
       uses: softprops/action-gh-release@v1
       if: startsWith(github.ref, 'refs/tags/')
       with:
         files: dist/config-assessment-tool-linux.tgz
         token: ${{ secrets.WORKFLOW_TOKEN }}

  build-win:
   name: build windows binary
   runs-on: windows-latest
   steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    - name: Install Python 3
      uses: actions/setup-python@v2
      with:
        python-version: 3.9
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pipenv pyinstaller
        # install to global namespace and then clean up, no need for venv setup
        pipenv install --dev --system
    - name: Use pip installation to get around github hosted runner path issues
      run: |
        pipenv lock -r > requirements.txt
        pip install -r requirements.txt
        pyinstaller dist/config-assessment-tool-windows.spec
    - name: Create zip file for distribution
      uses: thedoctor0/zip-release@master
      with:
        type: 'zip'
        filename: 'dist/config-assessment-tool-windows.zip'
        path: 'dist/config-assessment-tool-windows'
    - name: Release the bundle for Windows
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: dist/config-assessment-tool-windows.zip
        token: ${{ secrets.WORKFLOW_TOKEN }}
