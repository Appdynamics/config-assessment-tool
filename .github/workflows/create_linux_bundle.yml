name: Create Platform specific bundles
on:
  release:
    types: [ published ]

jobs:

  build-linux:
   name: build linux binary
   runs-on: ubuntu-latest
   steps:
     - name: Checkout repository
       uses: actions/checkout@v2
     - name: Install dependencies
       run: |
         pwd
         ls -altr
         echo "switching to backend directory"
         cd backend
         # build image which builds the bundle for glibc 2.15+
         docker build --file Dockerfile-github-workflow-bundle --tag config-assessment-tool-linux .
         # copy bundle out of built image
         tarball_path=$(docker run --rm config-assessment-tool-linux:latest find /root/config-assessment-tool/dist/appdynamics/ -name *.tgz)
         echo "tarball_path: $tarball_path"
         cd ..
         docker cp $(docker create --name temp_image config-assessment-tool-linux:latest):$tarball_path ./ && docker rm temp_image
         echo "printing current directory"
         pwd
         ls -altr
         echo "finished finding tgz"
         find .
         echo "current directory"
         pwd
     - name: Release the bundle for linux
       uses: softprops/action-gh-release@v1
       if: startsWith(github.ref, 'refs/tags/')
       with:
         files: ./*.tgz
         token: ${{ secrets.WORKFLOW_TOKEN }}
     - name: Keep workflow artifact within the current workflow namespace
       uses: actions/upload-artifact@v3
       with:
        name: config-assessment-tool-linux.tgz
        path: ./config-assessment-tool-linux-*.tgz
        if-no-files-found: warn