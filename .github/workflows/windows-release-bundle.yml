# .github/workflows/windows-release-bundle.yml
name: Create Windows Bundle

on:
  release:
    types: [ published ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-win:
    name: build windows binary
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Install Python 3
        uses: actions/setup-python@v5
        with:
          python-version: 3.9

      - name: Install dependencies (pipenv, pyinstaller)
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          pip install pipenv pyinstaller
          # install to global namespace and then clean up, no need for venv setup
          pipenv install --dev --system

      - name: Build executable and create zip bundle
        id: install_it # Keep the ID for referencing outputs
        shell: pwsh
        run: |
          # Ensure we are at the repository root for consistent pathing
          Set-Location -Path "${{ github.workspace }}"

          # Generate requirements.txt from Pipfile.lock
          pipenv requirements --dev > requirements.txt

          # Install all requirements for PyInstaller
          # Use pip to install directly, as pipenv install --system already handled the main deps
          pip install -r requirements.txt

          # Run PyInstaller to build the executable
          pyinstaller --distpath=./dist/appdynamics backend/config-assessment-tool.spec

          # Dynamically determine the PyInstaller output directory name
          # This assumes PyInstaller creates a directory like 'config-assessment-tool-windows-vX.Y.Z'
          # within ./dist/appdynamics. We use Select-Object -ExpandProperty Name to get the string.
          $pyinstallerOutputDirName = (Get-ChildItem -Path "./dist/appdynamics" -Directory -Filter "config-assessment-tool-*" | Select-Object -ExpandProperty Name)
          
          # Define the full path to the PyInstaller output directory
          $sourcePathFor7z = Join-Path -Path "./dist/appdynamics" -ChildPath $pyinstallerOutputDirName

          # Define the desired name for the output zip file
          $zipFileName = "${pyinstallerOutputDirName}.zip"
          # Define the full path where the zip file should be created (in the ./dist folder)
          $zipFilePath = Join-Path -Path "./dist" -ChildPath $zipFileName

          # Create the zip archive
          # 'a' for add, "$zipFilePath" is the target archive, "${sourcePathFor7z}\*" archives the CONTENTS of the directory
          # -xr!logs excludes any 'logs' directory if it exists within the bundled output
          7z a "$zipFilePath" "${sourcePathFor7z}\*" -xr!logs

          # Set the output variable with the correct zip file name
          # This variable will be used by subsequent steps to locate the file
          echo "bundle_name=$zipFileName" >> $env:GITHUB_OUTPUT

      - name: Release the bundle for Windows
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          # Reference the output variable correctly using ${{ steps.<step_id>.outputs.<output_name> }}
          files: dist/${{ steps.install_it.outputs.bundle_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          overwrite_files: true

      - name: Keep workflow artifact within the current workflow namespace
        uses: actions/upload-artifact@v4
        with:
          # Reference the output variable correctly
          name: ${{ steps.install_it.outputs.bundle_name }}
          path: dist/${{ steps.install_it.outputs.bundle_name }}
          if-no-files-found: ignore