# .github/workflows/release-linux.yml
name: Create Linux Bundle
on:
  release:
    types: [published]
  workflow_dispatch: # Allows manual triggering

jobs:
  build-linux:
    name: Build Linux Executable Bundle
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Build Docker image with bundle
        run: |
          # Build image which builds the bundle for glibc 2.15+
          docker build --file backend/Dockerfile-github-workflow-bundle --tag config-assessment-tool-linux .
          echo "Finished building docker image with bundle included"

      - name: Copy bundle out of built image
        run: |
          # Copy bundle out of built image
          # The find command dynamically locates the .tgz file created by the Dockerfile
          tarball_path=$(docker run --rm config-assessment-tool-linux:latest find /root/config-assessment-tool/dist/ -name "*.tgz")
          echo "Copying bundle out of image using $tarball_path"
          docker cp $(docker create --name temp_image config-assessment-tool-linux:latest):$tarball_path ./ && docker rm temp_image
          echo "Finished copying bundle onto hosted runner at $(pwd)"
          echo "Files in current directory: $(ls -altr)"

      - name: Release the bundle for Linux
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ./*.tgz # Assumes only one .tgz file is present in the current directory
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Keep workflow artifact within the current workflow namespace
        uses: actions/upload-artifact@v3
        with:
          name: config-assessment-tool-linux.tgz # Generic name for artifact, will pick up the actual file
          path: ./config-assessment-tool-linux-*.tgz
          if-no-files-found: ignore